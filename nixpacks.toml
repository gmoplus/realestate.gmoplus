[phases.setup]
nixPkgs = ["php83", "php83Extensions.mbstring", "php83Extensions.gd", "php83Extensions.pdo", "php83Extensions.pdo_mysql", "php83Extensions.mysqli", "php83Extensions.zip", "php83Extensions.curl", "php83Extensions.xml", "php83Extensions.bcmath", "php83Extensions.intl", "mariadb-client", "apacheHttpd"]

[phases.build]
cmds = [
    "mkdir -p tmp/compile tmp/cache tmp/upload files plugins",
    "chmod -R 777 tmp",
    "chmod -R 777 files",
    "chmod -R 777 plugins",
    "mkdir -p /var/run/apache2 /var/lock/apache2 /var/log/apache2",
    "sed -i 's|DocumentRoot \"/usr/local/apache2/htdocs\"|DocumentRoot \"/app\"|g' /usr/local/apache2/conf/httpd.conf",
    "sed -i 's|<Directory \"/usr/local/apache2/htdocs\">|<Directory \"/app\">|g' /usr/local/apache2/conf/httpd.conf",
    "sed -i 's|DirectoryIndex index.html|DirectoryIndex index.php index.html|g' /usr/local/apache2/conf/httpd.conf",
    "echo 'LoadModule rewrite_module modules/mod_rewrite.so' >> /usr/local/apache2/conf/httpd.conf",
    "echo '<Directory \"/app\">' >> /usr/local/apache2/conf/httpd.conf",
    "echo '    AllowOverride All' >> /usr/local/apache2/conf/httpd.conf",
    "echo '    Require all granted' >> /usr/local/apache2/conf/httpd.conf",
    "echo '</Directory>' >> /usr/local/apache2/conf/httpd.conf"
]

[start]
cmd = "rm -f /app/tmp/compile/*.php && httpd -D FOREGROUND"
